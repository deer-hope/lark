<!DOCTYPE HTML><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>0 框架以及基本约定</title>
    
<style id="wiz_custom_css">html, body {font-size: 12pt;}body {font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;line-height: 1.6;margin: 0 auto;padding: 20px 16px;padding: 1.25rem 1rem;}h1, h2, h3, h4, h5, h6 {margin:20px 0 10px;margin:1.25rem 0 0.625rem;padding: 0;font-weight: bold;}h1 {font-size:20pt;font-size:1.67rem;}h2 {font-size:18pt;font-size:1.5rem;}h3 {font-size:15pt;font-size:1.25rem;}h4 {font-size:14pt;font-size:1.17rem;}h5 {font-size:12pt;font-size:1rem;}h6 {font-size:12pt;font-size:1rem;color: #777777;margin: 1rem 0;}div, p, ul, ol, dl, li {margin:0;}blockquote, table, pre, code {margin:8px 0;}ul, ol {padding-left:32px;padding-left:2rem;}ol.wiz-list-level1 > li {list-style-type:decimal;}ol.wiz-list-level2 > li {list-style-type:lower-latin;}ol.wiz-list-level3 > li {list-style-type:lower-roman;}blockquote {padding:0 12px;padding:0 0.75rem;}blockquote > :first-child {margin-top:0;}blockquote > :last-child {margin-bottom:0;}img {border:0;max-width:100%;height:auto !important;margin:2px 0;}table {border-collapse:collapse;border:1px solid #bbbbbb;}td, th {padding:4px 8px;border-collapse:collapse;border:1px solid #bbbbbb;min-height:28px;word-break:break-all;box-sizing: border-box;}.wiz-hide {display:none !important;}</style></head>

<body class=""  spellcheck="false"><div>1、当前百灵鸟服务端支持tcp和websocket两种协议，但是当前系统不能同时启动两个协议，不是因为设计的限制，而是因为还没有</div><div>去写同时启动两个端口监听的代码。通信协议均使用文本协议。</div><div><br></div><div>2、服务端ip：114.67.227.241，端口：8808，使用websocket协议连接服务器的地址：ws://114.67.227.241:8808/websocket</div><div>使用tcp连接服务器的方式，按照正常的socket连接方法连接即可，当前系统使用的websocket，没有启动tcp模式</div><div><br></div><div>3、连接方式与通信协议无关，但是通信层面的编码有一个小的区别，使用websocket时，按照websocket协议进行通信是没有问题，</div><div>但是使用tcp模式的通信模式时，协议包需要加一个协议单位（PTU）结束符表示，当时使用的结束符表<span data-wiz-span="data-wiz-span">示是：</span><span style=""><span data-wiz-span="data-wiz-span">\r\n。</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">举例：假设你要发送的文本协议是：</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">{"body":{"ticket":"DEEI6dBBmfZ2il56jrqTEXfaIqQxjEbT9Y8/pS8Rt9s="},"time":1526900381750,"transactionId":"5143de0e-5150-4391-bb11-92c96798469c","type":"listContact","version":1}</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">那么你在websocket模式时，直接将其打包进入一个<span style="font-size:1.167rem;color:WindowText;font-family:'Courier New';">TextWebSocketFrame的载荷字段即可。</span></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><span style="font-size:1.167rem;color:WindowText;font-family:'Courier New';">但是针对tcp模式，则需要在末尾加上<span style="color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;display:inline !important;">\r\n</span></span></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><span style="font-size:1.167rem;color:WindowText;font-family:'Courier New';"><span style="color:rgb(0, 0, 0);font-family:Helvetica, 'Hiragino Sans GB', 微软雅黑, 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;font-size:1rem;font-style:normal;font-weight:normal;text-align:start;text-indent:0px;display:inline !important;"><br></span></span></span></span></div><div>4、tcp模式和websocket模式是互通的。</div><div><br></div><div><span data-wiz-span="data-wiz-span">5、同一个用户可以登录多次，不会进行互踢，这种有一个重要的概念，叫做活跃连接。</span></div><div><span data-wiz-span="data-wiz-span">活跃连接定义如下：最后一次进行发送过</span><span style=""><span data-wiz-span="data-wiz-span">singleChat消息的连接。</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">也就是说，如果同一个用户登录多次，最后一次用于发送消息的就是活跃连接。如果只登录一次，那当前这个连接</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">就是活跃连接。活跃连接的作用：如果对方给你发消息，那么消息只会推送到活跃的连接上。</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">6、通信基本框架：</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">（1）建立和服务端的连接</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">（2）使用登录协议进行登录</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">（3）使用获取联系人协议获取联系人</span></span></div><div><span style=""><span data-wiz-span="data-wiz-span">（4）发送聊天消息</span></span></div><div>同时，在登录完成后，需要启动一个独立的线程，向服务端发送心跳消息。后端设置的是</div><div>如果一分钟内没有收到心跳消息，则会主动关闭连接，建议客户端每隔45秒左右发送一次心跳</div><div><br></div><div>注意：登录过程是必须的，当前后台没有去验证所谓的用户名密码，发送登录消息的时候，必须要传入</div><div>一个合适的用户名，后台会为此用户名生成一个ticket，后面所有的协议都需要用到这个ticket。</div><div>客户端向服务器没法一次消息，服务端后会去延长ticket的有效时间，因此正常情况下，ticket基本是</div><div>一直有效。但是断开连接后，一般这个ticket就会立即变为无效</div><div><br></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div><div><span style=""><span data-wiz-span="data-wiz-span"><br></span></span></div></body></html>